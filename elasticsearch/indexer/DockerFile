FROM --platform=linux/amd64 python:3.9-buster

# 環境変数の設定
ENV DEBIAN_FRONTEND=noninteractive
ENV DEBCONF_NOWARNINGS=yes
ENV PATH="/opt/mssql-tools/bin:${PATH}"
ENV PYTHONUNBUFFERED=1

WORKDIR /app

COPY requirements.txt .
COPY index_data.py .
COPY install_msodbc.sh .

# install_msodbc.shに実行権限を付与
RUN chmod +x ./install_msodbc.sh

# 必要なパッケージのインストール
RUN ./install_msodbc.sh && \
    apt-get update && \
    apt-get install -y unixodbc mecab libmecab-dev mecab-ipadic-utf8 swig && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Pythonパッケージのインストール
RUN pip install --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# verbose実行オプションを追加
CMD ["python", "-v", "/app/index_data.py"]